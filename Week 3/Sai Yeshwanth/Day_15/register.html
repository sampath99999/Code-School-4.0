<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Register</title>
    <script defer src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>

  <body>
    <div
      class="card container-fluid d-flex justify-content-center align-items-center flex-column overflow-auto py-5"
    >
      <div
        class="w-100 border p-4 shadow rounded bg-white"
        style="max-width: 600px"
      >
        <h3 class="text-center">Register</h3>
        <form id="registerForm">
          <div class="row">
            <div class="col-md-6">
              <label for="firstName" class="form-label">First Name</label>
              <input type="text" class="form-control" id="firstName" />
              <div class="invalid-feedback"></div>
            </div>
            <div class="col-md-6">
              <label for="lastName" class="form-label">Last Name</label>
              <input type="text" class="form-control" id="lastName" />
              <div class="invalid-feedback"></div>
            </div>
          </div>

          <div class="mt-3">
            <label for="userName" class="form-label">Username</label>
            <input type="text" class="form-control" id="userName" />
            <div class="invalid-feedback"></div>
          </div>

          <div class="mt-3">
            <label for="phoneNumber" class="form-label">Phone Number</label>
            <input type="tel" class="form-control" id="phoneNumber" />
            <div class="invalid-feedback"></div>
          </div>

          <div class="mt-3">
            <label for="email" class="form-label">Email</label>
            <input type="email" class="form-control" id="email" />
            <div class="invalid-feedback"></div>
          </div>

          <div class="mt-3">
            <label for="birthDate" class="form-label">Date of Birth</label>
            <input type="date" class="form-control" id="birthDate" />
            <div class="invalid-feedback"></div>
          </div>

          <div class="mt-3">
            <label for="gender" class="form-label">Gender</label>
            <select class="form-control" id="gender">
              <option value="">Select Gender</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
              <option value="other">Other</option>
            </select>
            <div class="invalid-feedback"></div>
          </div>

          <div class="mt-3">
            <label for="passWord" class="form-label">Password</label>
            <input type="password" class="form-control" id="passWord" />
            <div class="invalid-feedback"></div>
          </div>

          <div class="mt-3">
            <label for="confirmPassword" class="form-label"
              >Confirm Password</label
            >
            <input type="password" class="form-control" id="confirmPassword" />
            <div class="invalid-feedback"></div>
          </div>

          <div class="mt-4 d-flex justify-content-center">
            <button type="submit" class="btn btn-primary w-25">Register</button>
          </div>
        </form>
      </div>

      <div
        id="contentDiv"
        class="container card p-3 shadow mt-5 mt-md-4 alert alert-secondary text-center"
        style="max-width: 610px"
      >
        <h5>Response:</h5>
        <p id="content" class="text-muted"></p>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
      const nameRegex = /^[A-Za-z.\s]+$/;
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      const phoneRegex = /^[6789]\d{9}$/;
      const passwordRegex =
        /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;

      const formFields = [
        {
          id: "firstName",
          label: "First Name",
          rules: ["required", "min:3", "max:25", "regex:name"],
        },
        {
          id: "lastName",
          label: "Last Name",
          rules: ["required", "min:3", "max:25", "regex:name"],
        },
        {
          id: "userName",
          label: "Username",
          rules: ["required", "min:3", "max:25", "regex:name"],
        },
        {
          id: "phoneNumber",
          label: "Phone Number",
          rules: ["required", "regex:phone"],
        },
        { id: "email", label: "Email", rules: ["required", "regex:email"] },
        {
          id: "birthDate",
          label: "Date of Birth",
          rules: ["required", "age:18:60"],
        },
        { id: "gender", label: "Gender", rules: ["required"] },
        {
          id: "passWord",
          label: "Password",
          rules: ["required", "regex:password"],
        },
        {
          id: "confirmPassword",
          label: "Confirm Password",
          rules: ["required", "match:passWord"],
        },
      ];

      function validateField(field) {
        let value = $("#" + field.id)
          .val()
          .trim();
        let input = $("#" + field.id);
        let errorElement = input.next(".invalid-feedback");
        let isValid = true;

        for (let rule of field.rules) {
          if (rule === "required" && !value) {
            errorElement.text(`${field.label} is required.`);
            isValid = false;
          } else if (rule.startsWith("min:")) {
            let minLength = parseInt(rule.split(":")[1]);
            if (value.length < minLength) {
              errorElement.text(
                `${field.label} must be at least ${minLength} characters.`
              );
              isValid = false;
            }
          } else if (rule.startsWith("max:")) {
            let maxLength = parseInt(rule.split(":")[1]);
            if (value.length > maxLength) {
              errorElement.text(
                `${field.label} must be at most ${maxLength} characters.`
              );
              isValid = false;
            }
          } else if (rule.startsWith("regex:")) {
            let regexType = rule.split(":")[1];
            let regex;
            if (regexType === "name") regex = nameRegex;
            else if (regexType === "email") regex = emailRegex;
            else if (regexType === "phone") regex = phoneRegex;
            else if (regexType === "password") regex = passwordRegex;

            if (regex && !regex.test(value)) {
              errorElement.text(`Enter a valid ${field.label}.`);
              isValid = false;
            }
          } else if (rule.startsWith("match:")) {
            let matchField = rule.split(":")[1];
            if (value !== $("#" + matchField).val()) {
              errorElement.text("Passwords do not match.");
              isValid = false;
            }
          } else if (rule.startsWith("age:")) {
            let [_, minAge, maxAge] = rule.split(":");
            let birthDate = new Date(value);
            let today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            let monthDiff = today.getMonth() - birthDate.getMonth();
            if (
              monthDiff < 0 ||
              (monthDiff === 0 && today.getDate() < birthDate.getDate())
            ) {
              age--;
            }
            if (age < minAge || age > maxAge) {
              errorElement.text(
                `Age must be between ${minAge} and ${maxAge} years.`
              );
              isValid = false;
            }
          }
        }

        input
          .removeClass("is-valid is-invalid")
          .addClass(isValid ? "is-valid" : "is-invalid");
      }

      formFields.forEach((field) => {
        $("#" + field.id).on("input change", function () {
          validateField(field);
        });
      });

      $("#registerForm").on("submit", function (event) {
        event.preventDefault();
        let allValid = true;
        formFields.forEach((field) => {
          validateField(field);
          if (!$("#" + field.id).hasClass("is-valid")) {
            allValid = false;
          }
        });

        if (!allValid) {
          Swal.fire({
            title: "Error!",
            text: "Please fill the correct details!",
            icon: "error",
          });
          return;
        }

        let formData = {};
        formFields.forEach((field) => {
          formData[field.id] = $("#" + field.id)
            .val()
            .trim();
        });

        let birthDate = new Date(formData.birthDate);
        let today = new Date();
        formData.age = today.getFullYear() - birthDate.getFullYear();

        $.post(
          "https://dummyjson.com/users/add",
          formData,
          function (response) {
            Swal.fire({
              title: "Good job!",
              text: "You have successfully registered!",
              icon: "success",
            }).then(() => {
              $("#content").html(`
                    <strong>ID:</strong> ${response.id} <br>
                    <strong>Name:</strong> ${response.firstName} ${response.lastName} <br>
                    <strong>Email:</strong> ${response.email} <br>
                    <strong>Age:</strong> ${response.age} <br>
                    <strong>Gender:</strong> ${response.gender} <br>
                `);

              // $("#registerForm")[0].reset();
              $(".form-control").removeClass("is-valid is-invalid");

              $("#contentDiv").addClass("alert-success");
              $("#contentDiv").removeClass("alert-danger");

              console.log(response);
            });
          }
        ).fail(function (error) {
          Swal.fire({
            title: "Error!",
            text: "Failed to register. Please try again.",
            icon: "error",
          });
          $("#contentDiv").addClass("alert-danger");
          $("#contentDiv").removeClass("alert-success");
        });
      });
    </script>
  </body>
</html>
